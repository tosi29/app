# UI仕様書 - 配信管理アプリケーション

## 概要

本アプリケーションは、過去の配信の管理、人気配信の表示、検索、およびリスナーコメントの可視化を提供するWebアプリケーションです。タブベースのインターフェースと設定モーダルを提供し、4つの主要機能を持ちます。

## 技術スタック

### 使用技術

- **フレームワーク**: Next.js 15.2.4
- **言語**: TypeScript 5.8.3  
- **UIライブラリ**: React 18.2.0
- **スタイリング**: TailwindCSS 3.4.17
- **チャートライブラリ**: Recharts 3.0.2
- **開発ツール**: ESLint 8.56.0

### アーキテクチャ

- **ページ構成**: Single Page Application（SPA）形式
- **ルーティング**: Next.js Router（クライアントサイド）
- **API**: Next.js API Routes
- **状態管理**: React Hooks（useState, useEffect）

## 全体構成

### レイアウト構造

- ヘッダーエリア（タブナビゲーション + 設定アイコン）
- メインコンテンツエリア（動的切り替え）
- 設定モーダル（プラットフォーム切り替え）
- レスポンシブデザイン対応

### ナビゲーション構成

#### タブナビゲーション
1. **配信一覧** (`broadcasts`) - 過去の配信一覧表示
2. **人気の配信** (`popular`) - 人気配信のソート表示
3. **検索** (`search`) - キーワード・シリーズ検索  
4. **仮説** (`hypotheses`) - 仮説可視化（2D散布図）

#### 設定機能
- **設定アイコン** (⚙️) - タブエリア右上に配置
- **設定モーダル**: プラットフォーム切り替え（Spotify/YouTube）
- 全タブ共通で適用される再生プラットフォーム設定

## 1. 配信一覧タブ

### 機能概要

シリーズ別にグループ化された過去の配信一覧を表示。表示モードの切り替え、シリーズの展開/折りたたみ、ソート機能を提供します。

### 表示モード

#### グループ表示モード
- シリーズ別にグループ化して表示
- 各シリーズは展開/折りたたみ可能
- アルファベット順でシリーズ表示

#### 一覧表示モード
- 全配信を一覧表示
- ソート機能付き（日付、タイトル、再生時間）
- ソート方向指示子（↑↓）付きヘッダー

### 表示制御
- **表示モード切り替え**: グループ表示 / 一覧表示
- **すべて展開** / **すべて閉じる** ボタン（グループ表示時のみ）

### テーブル構成

| カラム | 内容 |
|--------|------|
| 日付 | YYYY-MM-DD形式 |
| タイトル | エピソードタイトル |
| 再生時間 | MM:SS形式 |
| リンク | 再生・コメント表示ボタン |

### ユーザーインタラクション

#### ホバー効果
- **行全体ホバー**: マウスカーソルを行の任意の場所に置くと行全体が薄いグレー（`bg-gray-50`）でハイライト
- **スムーズなトランジション**: `transition-colors duration-150`で自然な色変化
- **視覚的フィードバック**: どの行を操作対象にしているかが明確に分かる

### インタラクション機能

#### シリーズ展開/折りたたみ
- シリーズヘッダーをクリックで展開/折りたたみ
- 初期状態：全シリーズ閉じた状態
- トグルアイコン（▼/▶）で状態表示

#### アクションボタン
- **再生ボタン**: インライン埋め込みプレイヤーの表示/非表示切り替え
  - 表示状態：「非表示」ボタン
  - 非表示状態：「再生」ボタン（▶️アイコン）
  - プラットフォーム設定に応じてSpotify/YouTube埋め込み表示
- **仮説ボタン**: 仮説タブへ遷移（`/?tab=hypotheses&episodeId=${id}`）
  - 💬アイコン付き「仮説を見る」テキスト
- **概要ボタン**: 配信概要モーダル表示（概要データがある場合のみ）
  - 📝アイコン付き「概要」テキスト

#### 埋め込みプレイヤー
- テーブル行の下部に表示
- **Spotify**: 高さ200pxの埋め込み
- **YouTube**: 560x315pxの埋め込み
- レスポンシブ対応

### データ読み込み状態
- ローディング中："配信データを読み込み中..."表示

## 2. 人気の配信タブ

### 機能概要

人気の配信を閲覧数、コメント数、いいね数などでソート表示する機能を提供します。

### テーブル構成

| カラム | 内容 |
|--------|------|
| タイトル | エピソードタイトル + シリーズ名 |
| 再生 | 再生回数（数値） |
| コメント | コメント数 |
| 👍 | いいね数 |
| 日付 | YYYY-MM-DD形式 |
| リンク | 再生・コメント表示ボタン |

### ソート機能

#### ソート可能カラム
- **タイトル**: アルファベット順
- **再生**: 再生回数順  
- **コメント**: コメント数順
- **👍**: いいね数順
- **日付**: 日付順

#### ソート操作
- ヘッダークリックでソート実行
- 同一カラム再クリックで昇順/降順切り替え
- ソート方向指示子（↑↓）表示
- 初期設定：再生回数の降順

### ユーザーインタラクション

#### ホバー効果
- **行全体ホバー**: マウスカーソルを行の任意の場所に置くと行全体が薄いグレー（`bg-gray-50`）でハイライト
- **スムーズなトランジション**: `transition-colors duration-150`で自然な色変化
- **視覚的フィードバック**: どの行を操作対象にしているかが明確に分かる

### アクション機能
- **再生ボタン** (▶️): インライン埋め込みプレイヤー表示
- **停止ボタン** (⏹️): 埋め込みプレイヤー非表示  
- **仮説ボタン** (💬): 仮説タブへ遷移
- **概要ボタン** (📝): 配信概要モーダル表示（概要データがある場合のみ）

### データ読み込み状態
- ローディング中："人気の配信データを読み込み中..."表示

## 3. 検索タブ

### 機能概要

キーワードおよびシリーズフィルターによる配信検索機能を提供します。

### フォーム構成

#### 検索フィールド
- **検索キーワード入力**: タイトル・概要でのテキスト検索

#### 検索ボタン
- 通常状態："検索"
- ローディング状態："検索中..." + ボタン無効化

### 検索結果表示

#### 結果カード形式
各検索結果はカード形式で表示：
- **エピソードタイトル** （見出し）
- **シリーズ名** （サブタイトル）
- **エピソード概要** （説明文）
- **アクションボタン** （再生・コメント表示）
- **インライン埋め込みプレイヤー** （再生ボタン押下時）

#### 検索結果数表示
- "検索結果: {件数}件" ヘッダー表示

### アクション機能
- **再生ボタン**: カード内に埋め込みプレイヤー表示/非表示
- **仮説ボタン**: 仮説タブへ遷移
- **概要ボタン**: 配信概要モーダル表示（概要データがある場合のみ）

### 状態管理
- 検索実行前：フォームのみ表示
- 検索結果なし："該当する配信はありません。"メッセージ表示
- ローディング中：検索中表示

## 4. 仮説タブ（AI仮説自動抽出・可視化機能）

### 機能概要

AI仮説自動抽出・可視化機能により、エピソード別の仮説データをUMAP次元削減による2次元散布図で可視化します。BERTopicによるトピック分類を活用し、Plotlyライクなインタラクティブlegendを提供します。

### レイアウト構成

#### 3カラムレイアウト
- **左側**: UMAP散布図（グラフエリア）
- **中央**: インタラクティブlegend（トピック制御）
- **右側**: 仮説詳細リスト

#### レスポンシブ対応
- **デスクトップ**: 横並び3カラム
- **モバイル/タブレット**: 縦並びスタック

### グラフ仕様（UMAP散布図）

#### 座標系
- **2次元散布図**: 600x600px固定
- **X軸**: UMAP X座標（0-1正規化、軸ラベル非表示）
- **Y軸**: UMAP Y座標（0-1正規化、軸ラベル非表示）
- **グリッド**: 薄いグレーの点線グリッド

#### データポイント表示
- **基本サイズ**: 半径6px
- **選択時サイズ**: 半径8px + 黒ストローク
- **トピック別色分け**: 14色のカラーパレット対応
- **透明化制御**: 非表示トピックは opacity 0.1

### インタラクティブlegend機能（Plotlyライク）

#### 基本操作
- **シングルクリック**: トピックの表示/非表示切り替え
- **ダブルクリック**: 選択トピックのみ表示（isolate機能）
- **再度ダブルクリック**: 全トピック表示復元

#### 視覚的フィードバック
- **非表示状態**: 半透明化 + 取り消し線表示
- **分離表示状態**: 青い背景 + リング
- **ホバー効果**: 白背景 + シャドウ

#### レイアウト
- **縦型サイドバー**: 高さ600px、スクロール対応
- **コンパクト表示**: トピック名 + 件数の2行レイアウト
- **「すべて表示」ボタン**: 下部固定配置

### トピック分類システム

#### BERTopic対応トピック（14カテゴリ）
1. **リーダーシップ** (#3b82f6)
2. **教育手法** (#10b981)
3. **コミュニケーション** (#f59e0b)
4. **技術革新** (#8b5cf6)
5. **社会変化** (#ef4444)
6. **認知科学** (#06b6d4)
7. **人工知能** (#ec4899)
8. **仮想現実** (#84cc16)
9. **先端科学** (#6366f1)
10. **人材育成** (#14b8a6)
11. **学問統合** (#f97316)
12. **時代背景** (#a855f7)
13. **学習理論** (#22c55e)
14. **その他** (#6b7280)

### インタラクション機能

#### グラフインタラクション
- **ホバー**: ツールチップ表示（非表示トピックは無効）
- **クリック**: 仮説選択 + 右側リストでハイライト・スクロール
- **クリック無効化**: 非表示トピックの点は操作不可

#### ツールチップ内容
- エピソードタイトル + シリーズ名
- トピック色インジケーター + トピック名
- 仮説テキスト
- 支持する事実・根拠
- 提案者情報

#### 右側リスト機能
- **自動スクロール**: グラフクリック時に該当仮説へスクロール
- **ハイライト表示**: 選択仮説の青ボーダー + 背景色
- **フィードバックボタン**: 🤔興味深い、✨画期的、🎯検証したい
- **ソート**: 信頼度スコア降順

### フィルタリング機能

#### 配信フィルター
- **ドロップダウン**: 全配信 or 特定配信
- **URLパラメータ対応**: `episodeId`指定

#### トピックフィルター
- **ドロップダウン**: 全トピック or 特定トピック
- **legend連動**: legendとフィルターが相互連動

### 表示状態管理

#### 状態の種類
- **通常表示**: 全トピック表示
- **部分非表示**: 一部トピックを非表示
- **分離表示**: 特定トピックのみ表示
- **ローディング**: "仮説を読み込んでいます..."

#### 透明化アプローチ
- **座標固定**: 非表示でも点の位置は維持
- **視覚制御**: opacity制御による表示/非表示
- **安定性**: トピック切り替え時も点が移動しない

## データ構造

### 配信データ（PastBroadcast）

```typescript
interface PastBroadcast {
  id: number;
  date: string;              // YYYY-MM-DD形式
  title: string;             // エピソードタイトル
  excerpt: string;           // 概要テキスト
  series: string;            // シリーズ名
  duration: string;          // MM:SS形式
  url: string;               // 配信URL
  youtube_video_id: string;  // YouTube動画ID
  spotify_episode_id: string; // SpotifyエピソードID
  likeCount?: number;        // いいね数（オプショナル）
  summary?: BroadcastSummary; // 配信概要（オプショナル）
}
```

### 配信概要データ（BroadcastSummary）

```typescript
interface BroadcastSummary {
  overview: string;   // 今回の配信概要：50文字
  facts: string[];    // 事実や出来事：3行
  lessons: string[];  // 学び・教訓・法則：3行
}
```

### 仮説データ（Hypothesis）

```typescript
interface Hypothesis {
  id: number;                // 仮説ID
  episodeId: number;         // 関連するエピソードID
  hypothesis: string;        // 仮説の内容
  fact: string;             // 仮説を支える事実・根拠
  x: number;                // UMAP次元削減によるX座標（0-1正規化）
  y: number;                // UMAP次元削減によるY座標（0-1正規化）
  proposer: string;         // 仮説提案者（'AI'など）
  topic: string;            // BERTopicによる分類トピック名
  createdAt: string;        // ISO 8601形式の作成日時
  confidenceScore: number;  // 信頼度スコア（0-1、1が最も確信度が高い）
  originalityScore: number; // 独創性スコア（0-1、1が最も独創的・ユニーク）
}
```

### 人気配信データ（PopularBroadcast）

```typescript
interface PopularBroadcast extends PastBroadcast {
  commentCount: number;   // コメント数
  viewCount: number;      // 再生回数
}
```

### 検索API結果データ（RetrievalResult）

```typescript
interface RetrievalResult {
  content: {
    text: string;
    type: "TEXT";
  };
  metadata: {
    episode_id: string;
    series_name: string;
    series_number: string;
    label?: string;
    title: string;
    duration: number;
    position?: number;
    spotify_episode_id?: string;
    youtube_video_id?: string;
  };
  score: number;
}
```

## API仕様

### エンドポイント

- **GET /api/broadcasts**: 全配信データ取得
- **GET /api/popular-broadcasts**: 人気配信データ取得（再生回数・コメント数付き）
- **GET /api/search-broadcasts**: 検索機能
  - クエリパラメータ：`query`（検索キーワード）
  - レスポンス形式：`RetrievalResult[]`（検索結果配列）
  - 外部Lambda API統合対応
- **GET /api/hypotheses**: 仮説データ取得
  - クエリパラメータ：`episodeId`（特定エピソード指定）
  - 全仮説データまたはエピソード別フィルタリング

## URLルーティング

### パラメーター仕様

- **タブ切り替え**: `/?tab={tabId}`
  - `tab=broadcasts`: 配信一覧タブ
  - `tab=popular`: 人気の配信タブ
  - `tab=search`: 検索タブ  
  - `tab=hypotheses`: 仮説タブ

- **エピソード指定**: `/?tab=hypotheses&episodeId={id}`
  - 特定エピソードの仮説表示

### ナビゲーション動作

- **Shallow routing**: ページリロードなしでURL更新
- `router.replace()` を使用してブラウザ履歴の最適化
- ブラウザの戻る/進むボタンに対応

## ローディング・エラー状態

### ローディング表示
- 配信一覧："配信データを読み込み中..."
- 人気の配信："人気の配信データを読み込み中..."
- 仮説："仮説データを読み込んでいます..."
- 検索："検索中..."

### エラーハンドリング
- API呼び出し失敗時はコンソールエラーログ出力
- 検索結果なし時："該当する配信はありません。"表示

## 設定モーダル機能

### 機能概要
- タブエリア右上の設定アイコン（⚙️）から起動
- プラットフォーム切り替え設定を提供
- 選択したプラットフォームが全タブの再生機能に適用

### モーダル構成
- **ヘッダー**: "設定" タイトル + 閉じるボタン（✕）
- **コンテンツエリア**: プラットフォーム選択UI
- **背景**: クリックで閉じる半透明オーバーレイ

### プラットフォーム選択
- **ラベル**: "再生プラットフォーム:"
- **Spotifyボタン**: アクティブ時は主要色、非アクティブ時は標準背景
- **YouTubeボタン**: アクティブ時は主要色、非アクティブ時は標準背景

### 動作
- 設定アイコンクリックでモーダル表示
- プラットフォームボタンクリックで即座に切り替え
- 既に表示中の埋め込みプレイヤーも新しいプラットフォームに切り替わる
- 背景クリックまたは✕ボタンでモーダル閉じる

## 配信概要モーダル機能

### 機能概要
- 配信の概要情報を表示するモーダルダイアログ
- 概要データが存在する配信に対してのみ表示される概要ボタンから起動
- 構造化された配信内容サマリーを提供

### モーダル構成
- **ヘッダー**: "配信概要" タイトル + 閉じるボタン（✕）
- **コンテンツエリア**: 
  - **配信概要**: 50文字程度の配信の要約
  - **事実や出来事**: 配信中に話された事実のリスト表示
  - **学び・教訓・法則**: 配信から得られる学びのリスト表示
- **背景**: クリックで閉じる半透明オーバーレイ

### 表示内容
#### 概要セクション
- エピソードタイトルとシリーズ名
- 配信概要テキスト（overview）

#### 事実・出来事セクション
- 配信中に言及された事実や出来事のリスト
- 各項目は箇条書きで表示

#### 学び・教訓セクション  
- 配信から得られる学びや教訓のリスト
- 各項目は箇条書きで表示

### 動作
- 概要ボタンクリックでモーダル表示
- 背景クリックまたは✕ボタンでモーダル閉じる
- モーダル表示中は背景スクロール無効化

## Playwright MCPテスト結果

### テスト実施日
2025年6月30日

### テスト対象画面
- ✅ **配信一覧タブ**: シリーズ展開/折りたたみ、表示モード切り替え機能確認
- ✅ **人気の配信タブ**: データ読み込みとタブ切り替え確認
- ✅ **検索タブ**: キーワード検索（「吉田松陰」）で10件の結果表示確認
- ✅ **仮説タブ**: アクセス確認（詳細テストは大容量データのため制限）

### 確認済み操作
- タブ間の切り替え（4つすべて）
- シリーズの展開/折りたたみ操作
- 検索機能（テキスト入力 → 検索実行 → 結果表示）
- 基本的なブラウザインタラクション（クリック、入力、ナビゲーション）

### 制約事項
- **レスポンスサイズ制限**: 25,000トークン超過時は詳細確認不可
- **大容量データページ**: 人気の配信、仮説、設定モーダルでは要素指定が必要
- **開発サーバー**: 起動後3秒以上の待機時間が必要

### データ規模
- **配信データ**: 約500件（60シリーズ）
- **検索結果**: 通常10-50件
- **仮説データ**: エピソード別に複数仮説

---

*この仕様書は現在のソースコードベース（2025年6月）に基づいて作成されています。仮説タブのRecharts統合、シンプル化されたグラフ表示、外部API統合、Playwright MCPツールでの動作確認などの最新機能を反映しています。*